<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>آب و هوا بر پایه IOT</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link rel="manifest" href="manifest.json">
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log("Service Worker registered."))
      .catch(err => console.error("Service Worker failed:", err));
  }
</script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Tahoma, sans-serif;
    }
    #map {
      height: 500px;
      width: 100%;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    body {
      text-align: center;
      padding: 20px;
      direction: rtl;
      background-color: #f9f9f9;
    }ُ
    .info-box {
      margin: 10px auto;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 800px;
      text-align: right;
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
    }
    h3 {
      color: #235e30;
      margin-bottom: 20px;
    }
    #search-container {
      margin: 20px 0;
    }
    #search-box {
      padding: 10px;
      width: 300px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 25px;
      justify-content: center
    }
    #search-btn {
      padding: 10px 15px;
      background-color: #3498db00;
      color: rgb(0, 0, 0);
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 25px;
      margin-right: -10px;
    }
    #search-btn:hover {
      background-color: #2980b9;
    }
    .weather-icon {
      font-size: 24px;
      margin: 0 5px;
      vertical-align: middle;
    }
    .weather-details {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      margin-top: 15px;
    }
    .weather-item {
      margin: 5px;
      padding: 10px;
      min-width: 120px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .hourly-forecast {
      overflow-x: auto;
      white-space: nowrap;
      margin-top: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .hourly-item {
      display: inline-block;
      padding: 10px;
      margin: 0 5px;
      background-color: #e9f5ff;
      border-radius: 5px;
      text-align: center;
      min-width: 80px;
    }
    .sun-times {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }
    .sun-time {
      margin: 0 15px;
      color: #e67e22;
      font-weight: bold;
    }
    #coords {
      margin-top: 10px;
      color: #7f8c8d;
    }
    .tab-container {
      margin: 20px 0;
    }
    .tab-buttons {
      display: flex;
      justify-content: center;
      margin-bottom: 10px;
    }
    .tab-btn {
      padding: 8px 15px;
      background-color: #ecf0f1;
      border: none;
      cursor: pointer;
      margin: 0 5px;
      border-radius: 4px;
    }
    .tab-btn.active {
      background-color: #3498db;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <h2>پلتفرم استعلام وضعیت آب و هوا Powered By IOT</h2>
  <h3>برای دیدن وضعیت آب و هوا اسم شهر مورد نظر را وارد و<br> یا با انتخاب محل مورد نظر در نقشه، اطلاعات آب و هوایی آن نقطه را مشاهده کنید</h3>
  
  <div id="search-container">
    <input type="text" id="search-box" placeholder="نام شهر را وارد کنید...">
    <button id="search-btn"><i class="fas fa-search"></i> </button>
  </div>
  
  <div id="map"></div>
  
  <div class="info-box">
    <div id="location-info"><i class="fas fa-map-marker-alt"></i> مکان: -</div>
    <div id="coords">مختصات: -</div>
    <div id="current-weather">
      <div id="weather-main">وضعیت هوا: -</div>
      <div class="weather-details">
        <div class="weather-item"><i class="fas fa-temperature-high weather-icon"></i> دما: <span id="temp">-</span>°C</div>
        <div class="weather-item"><i class="fas fa-wind weather-icon"></i> باد: <span id="wind">-</span> km/h</div>
        <div class="weather-item"><i class="fas fa-tint weather-icon"></i> رطوبت: <span id="humidity">-</span>%</div>
        <div class="weather-item"><i class="fas fa-tachometer-alt weather-icon"></i> فشار: <span id="pressure">-</span> hPa</div>
      </div>
      <div class="sun-times">
        <div class="sun-time"><i class="fas fa-sunrise weather-icon"></i> طلوع: <span id="sunrise">-</span></div>
        <div class="sun-time"><i class="fas fa-sunset weather-icon"></i> غروب: <span id="sunset">-</span></div>
      </div>
    </div>
  </div>
  
  <div class="tab-container">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="hourly">پیش‌بینی ساعتی</button>
      <button class="tab-btn" data-tab="daily">پیش‌بینی روزانه</button>
    </div>
    
    <div id="hourly" class="tab-content active">
      <div class="hourly-forecast" id="hourly-forecast"></div>
    </div>
    
    <div id="daily" class="tab-content">
      <div class="daily-forecast" id="daily-forecast"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // تنظیمات اولیه نقشه
      const map = L.map('map').setView([32.4279, 53.6880], 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      let marker = null;
      const searchBox = document.getElementById('search-box');
      const searchBtn = document.getElementById('search-btn');
      const tabBtns = document.querySelectorAll('.tab-btn');

    
      tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          tabBtns.forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });

      //کلیک روی نقشه
      map.on('click', function(e) {
        updateWeatherData(e.latlng.lat, e.latlng.lng);
      });

      // جستجوی شهر
      searchBtn.addEventListener('click', function() {
        if (searchBox.value.trim() === '') return;
        searchCity(searchBox.value);
      });

      // جستجوی شهر    
      searchBox.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchBtn.click();
        }
      });

      // تابع جستجوی شهر
      function searchCity(cityName) {
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(cityName)}&accept-language=fa`)
          .then(response => response.json())
          .then(data => {
            if (data.length > 0) {
              const lat = parseFloat(data[0].lat);
              const lon = parseFloat(data[0].lon);
              map.setView([lat, lon], 12);
              updateWeatherData(lat, lon);
              searchBox.value = '';
            } else {
              alert('شهر یافت نشد! لطفاً نام دیگری امتحان کنید.');
            }
          })
          .catch(error => {
            console.error("خطا در جستجوی شهر:", error);
            alert('خطا در ارتباط با سرور جستجو');
          });
      }

      // تابع به‌روزرسانی اطلاعات آب و هوا
      function updateWeatherData(lat, lon) {
        // به‌روزرسانی مختصات روی نقشه
        if (marker) {
          map.removeLayer(marker);
        }
        marker = L.marker([lat, lon]).addTo(map)
          .bindPopup(`مختصات: ${lat.toFixed(4)}, ${lon.toFixed(4)}`)
          .openPopup();
        
        // نمایش مختصات
        document.getElementById("coords").innerText = `مختصات: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        
        // دریافت اطلاعات مکان
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=fa`)
          .then(response => response.json())
          .then(locationData => {
            const locationName = locationData.display_name || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
            document.getElementById("location-info").innerHTML = `<i class="fas fa-map-marker-alt"></i> مکان: ${locationName}`;
          });

        // دریافت اطلاعات آب و هوا
        const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,relativehumidity_2m,pressure_msl,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset&current_weather=true&timezone=auto`;
        
        fetch(weatherUrl)
          .then(response => response.json())
          .then(data => {
            const current = data.current_weather;
            document.getElementById("temp").innerText = current.temperature;
            document.getElementById("wind").innerText = current.windspeed;
            
            // اطلاعات ساعتی
            const hourly = data.hourly;
            const currentHour = new Date().getHours();
            document.getElementById("humidity").innerText = hourly.relativehumidity_2m[currentHour];
            document.getElementById("pressure").innerText = hourly.pressure_msl[currentHour].toFixed(0);
            
            // زمان طلوع و غروب
            const sunriseTime = new Date(data.daily.sunrise[0]);
            const sunsetTime = new Date(data.daily.sunset[0]);
            document.getElementById("sunrise").innerText = sunriseTime.toLocaleTimeString('fa-IR');
            document.getElementById("sunset").innerText = sunsetTime.toLocaleTimeString('fa-IR');
            
            const weatherCode = current.weathercode;
            const weatherIcon = getWeatherIcon(weatherCode);
            const weatherDesc = getWeatherDescription(weatherCode);
            document.getElementById("weather-main").innerHTML = `وضعیت هوا: ${weatherDesc} ${weatherIcon}`;
            
            updateHourlyForecast(hourly);
            
            updateDailyForecast(data.daily);
          })
          .catch(error => {
            console.error("خطا در دریافت اطلاعات هوا:", error);
            alert('خطا در دریافت اطلاعات آب و هوا. لطفاً دوباره امتحان کنید.');
          });
      }

      //  به‌روزرسانی پیش‌ بینی ساعتی
      function updateHourlyForecast(hourly) {
        const hourlyContainer = document.getElementById('hourly-forecast');
        hourlyContainer.innerHTML = '';
        
        const now = new Date();
        const currentHour = now.getHours();
        
        for (let i = currentHour; i < currentHour + 24; i++) {
          if (i >= hourly.time.length) break;
          
          const time = new Date(hourly.time[i]);
          const hour = time.getHours();
          const temp = hourly.temperature_2m[i];
          const weatherCode = hourly.weathercode[i];
          const weatherIcon = getWeatherIcon(weatherCode);
          
          const hourElement = document.createElement('div');
          hourElement.className = 'hourly-item';
          hourElement.innerHTML = `
            <div><strong>${hour}:00</strong></div>
            <div>${weatherIcon}</div>
            <div>${temp}°C</div>
          `;
          
          hourlyContainer.appendChild(hourElement);
        }
      }

      //  به‌روزرسانی پیش‌ بینی روزانه
      function updateDailyForecast(daily) {
        const dailyContainer = document.getElementById('daily-forecast');
        dailyContainer.innerHTML = '';
        
        for (let i = 0; i < 7; i++) {
          const date = new Date(daily.time[i]);
          const dayName = date.toLocaleDateString('fa-IR', { weekday: 'long' });
          const maxTemp = daily.temperature_2m_max[i];
          const minTemp = daily.temperature_2m_min[i];
          const weatherCode = daily.weathercode[i];
          const weatherIcon = getWeatherIcon(weatherCode);
          
          const dayElement = document.createElement('div');
          dayElement.className = 'weather-item';
          dayElement.innerHTML = `
            <div><strong>${dayName}</strong></div>
            <div>${weatherIcon}</div>
            <div>حداکثر: ${maxTemp}°C</div>
            <div>حداقل: ${minTemp}°C</div>
          `;
          
          dailyContainer.appendChild(dayElement);
        }
      }

      //  تبدیل کد آب و هوا به آیکون
      function getWeatherIcon(code) {
        if (code === 0) return '<i class="fas fa-sun weather-icon" style="color: #f39c12"></i>';
        if (code <= 3) return '<i class="fas fa-cloud-sun weather-icon" style="color: #95a5a6"></i>';
        if (code <= 48) return '<i class="fas fa-smog weather-icon" style="color: #7f8c8d"></i>';
        if (code <= 67 || code === 80 || code === 81 || code === 82) return '<i class="fas fa-cloud-rain weather-icon" style="color: #3498db"></i>';
        if (code <= 77) return '<i class="fas fa-snowflake weather-icon" style="color: #ecf0f1"></i>';
        if (code <= 99) return '<i class="fas fa-bolt weather-icon" style="color: #f1c40f"></i>';
        return '<i class="fas fa-question weather-icon"></i>';
      }

      //  تبدیل کد آب و هوا به توضیح
      function getWeatherDescription(code) {
        const descriptions = {
          0: "آسمان صاف",
          1: "نیمه ابری",
          2: "ابرهای پراکنده",
          3: "ابری",
          45: "مه",
          48: "مه یخی",
          51: "نمنم باران",
          53: "باران ملایم",
          55: "باران شدید",
          56: "باران یخی",
          57: "باران یخی شدید",
          61: "باران ملایم",
          63: "باران",
          65: "باران شدید",
          66: "باران یخی",
          67: "باران یخی شدید",
          71: "بارش برف ملایم",
          73: "بارش برف",
          75: "بارش برف شدید",
          77: "دانه برف",
          80: "رگبار ملایم",
          81: "رگبار",
          82: "رگبار شدید",
          85: "برف ملایم",
          86: "برف شدید",
          95: "رعد و برق",
          96: "رعد و برق با بارش ملایم",
          99: "رعد و برق با بارش شدید"
        };
        return descriptions[code] || "نامشخص";
      }
    });
  </script>
</body>
</html>